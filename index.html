<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Plotting Tool v3.5@Yong (Global Scroll)</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f8f9fa; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
        
        #main-wrapper { display: flex; flex-direction: column; height: 100vh; }

        /* È†ÇÈÉ®Â∞éËà™Âàó */
        #top-nav {
            flex: 0 0 auto;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            padding: 5px 10px 0 10px;
            display: flex;
            align-items: flex-end;
        }
        .nav-tabs { border-bottom: none; flex-grow: 1; }
        .nav-tabs .nav-item { margin-right: 2px; }
        .nav-tabs .nav-link { 
            cursor: pointer; font-weight: 600; color: #495057; 
            border: 1px solid transparent; border-bottom: none;
            padding: 8px 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-tabs .nav-link:hover { background-color: #e9ecef; }
        .nav-tabs .nav-link.active { 
            color: #0d6efd; background-color: #f8f9fa; 
            border-color: #ddd #ddd #f8f9fa; 
        }
        
        .tab-close-btn {
            font-size: 0.8rem; width: 16px; height: 16px; line-height: 14px;
            text-align: center; border-radius: 50%; color: #999;
        }
        .tab-close-btn:hover { background-color: #dc3545; color: white; }

        #add-tab-btn {
            width: 30px; height: 30px; border-radius: 4px; border: 1px solid #ddd;
            background: #fff; color: #28a745; font-weight: bold; font-size: 1.2rem;
            line-height: 1; display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-left: 5px; margin-bottom: 5px;
        }
        #add-tab-btn:hover { background-color: #eafaf1; border-color: #28a745; }

        /* ÂÖßÂÆπÂçÄÂüü */
        #app-container { display: flex; flex: 1; overflow: hidden; }

        /* Â∑¶ÂÅ¥Èù¢Êùø - Ë®≠ÂÆö overflow-y: auto ËÆìÊï¥È´îÂèØÊç≤Âãï */
        #left-panel {
            width: 800px; 
            min-width: 250px; max-width: 1600px;
            background-color: #f8f9fa; border-right: 1px solid #ddd;
            overflow-y: auto; /* ÈóúÈçµÔºöÈñãÂïüÂûÇÁõ¥Êç≤Âãï */
            padding: 15px; display: flex; flex-direction: column;
            height: 100%; /* Â°´ÊªøÈ´òÂ∫¶ */
        }

        #h-resizer {
            width: 6px; background-color: #e9ecef; cursor: col-resize;
            display: flex; align-items: center; justify-content: center;
            border-left: 1px solid #dee2e6; border-right: 1px solid #dee2e6; z-index: 10;
        }
        #h-resizer:hover, #h-resizer.resizing { background-color: #ced4da; }

        #right-panel {
            flex-grow: 1; background-color: #ffffff; display: flex;
            flex-direction: column; overflow: hidden; padding: 10px;
        }

        #v-resizer {
            height: 8px; background-color: #e9ecef; cursor: row-resize;
            display: flex; align-items: center; justify-content: center;
            margin: 5px 0; border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6; flex-shrink: 0;
        }
        #v-resizer:hover, #v-resizer.resizing { background-color: #ced4da; }

        #chart-container { height: 60%; min-height: 200px; display: flex; flex-direction: column; }
        #table-container { flex: 1; min-height: 150px; display: flex; flex-direction: column; overflow: hidden; }

        .card { margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; flex-shrink: 0; }
        .card-header { font-weight: 600; padding: 6px 15px; font-size: 0.9rem; }
        .card-body { padding: 10px; }
        
        #plotDiv { width: 100%; height: 100%; background: white; }
        .table-responsive { overflow-y: auto; } /* ÁßªÈô§ height: 100% ÊîπÁî± max-height ÊéßÂà∂ */
        .axis-label { font-size: 0.75rem; color: #666; margin-bottom: 2px; }
        
        #markerTable { border-collapse: separate; border-spacing: 0; width: 100%; }
        #markerTable td, #markerTable th { vertical-align: middle; background-color: transparent !important; padding: 4px 8px; }
        #markerTable thead th, #fileTable thead th { position: sticky; top: 0; z-index: 1; background-color: #f8f9fa; }
        
        .sortable-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable-header:hover { background-color: #e9ecef; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .no-select { user-select: none; }
    </style>
</head>
<body>

<div id="main-wrapper">
    <div id="top-nav">
        <ul class="nav nav-tabs" id="tab-list"></ul>
        <div id="add-tab-btn" onclick="createNewTab()" title="Add New Plot">+</div>
    </div>

    <div id="app-container">
        <div id="left-panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Control Panel@Yong <span class="badge bg-secondary fs-6" id="version-badge">v3.5</span></h5>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white">1. File Selection</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="small fw-bold text-muted mb-1">Option 1: Select Files</label>
                        <div class="input-group input-group-sm">
                            <input type="file" class="form-control" id="csvFileInput" multiple accept=".csv">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted mb-1">Option 2: Select Folder</label>
                        <div class="input-group input-group-sm">
                            <input type="file" class="form-control" id="folderInput" webkitdirectory directory multiple>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between border-top pt-2">
                        <small class="text-muted" id="fileCount">0 files</small>
                        <button class="btn btn-xs btn-outline-danger" onclick="clearFiles()">Clear All</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white">2. Data Mapping</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="axis-label fw-bold">Header Row (Start Line)</label>
                        <input type="number" id="headerRowInput" class="form-control form-control-sm" value="1" min="1" onchange="reparseCurrentFiles()">
                    </div>
                    <label class="axis-label fw-bold">X-Axis Column</label>
                    <select id="xColSelect" class="form-select form-select-sm mb-2" disabled onchange="saveConfig(); resetMarkersAndPlot()"></select>
                    <label class="axis-label fw-bold">Y-Axis Column</label>
                    <select id="yColSelect" class="form-select form-select-sm" disabled onchange="saveConfig(); resetMarkersAndPlot()"></select>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span>3. Axis & Title</span>
                    <button class="btn btn-xs btn-light py-0 px-2" onclick="autoScale()">Auto</button>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="axis-label">Chart Title</label>
                        <input type="text" id="chartTitle" class="form-control form-control-sm" placeholder="Default: Y vs X" onchange="saveConfig()">
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col-6">
                            <input type="text" id="xLabelInput" class="form-control form-control-sm" placeholder="X Label (Optional)" onchange="saveConfig()">
                        </div>
                        <div class="col-6">
                            <input type="text" id="yLabelInput" class="form-control form-control-sm" placeholder="Y Label (Optional)" onchange="saveConfig()">
                        </div>
                    </div>

                    <div class="row g-1 mb-1">
                        <div class="col-12"><strong class="axis-label">X-Axis Range</strong></div>
                        <div class="col-4"><input type="number" id="xMin" class="form-control form-control-sm" placeholder="Min" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="xMax" class="form-control form-control-sm" placeholder="Max" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="xStep" class="form-control form-control-sm" placeholder="Step" onchange="saveConfig()"></div>
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col-12"><strong class="axis-label">Y-Axis Range</strong></div>
                        <div class="col-4"><input type="number" id="yMin" class="form-control form-control-sm" placeholder="Min" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="yMax" class="form-control form-control-sm" placeholder="Max" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="yStep" class="form-control form-control-sm" placeholder="Step" onchange="saveConfig()"></div>
                    </div>
                    
                    <div class="border-top pt-2 mt-2">
                        <label class="axis-label fw-bold text-danger">Spec Line (Y-Value)</label>
                        <input type="number" id="specInput" class="form-control form-control-sm" placeholder="e.g. -20 (Black Dashed Line)" onchange="saveConfig()">
                    </div>

                    <button class="btn btn-sm btn-success w-100 mt-3" id="plotBtn" disabled>Plot / Update</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center py-1">
                    <span>4. Series</span>
                    <div>
                        <button class="btn btn-xs btn-light py-0" onclick="toggleAllFiles(true)">All</button>
                        <button class="btn btn-xs btn-light py-0" onclick="toggleAllFiles(false)">None</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm table-hover mb-0" id="fileTable" style="font-size: 0.8rem;">
                            <thead class="table-light">
                                <tr>
                                    <th width="25"></th>
                                    <th class="sortable-header" onclick="sortFiles()" title="Click to Sort">
                                        Label <span id="sortIcon" style="font-size: 0.8rem; color: #666;">‚Üï</span>
                                    </th>
                                    <th width="35">Clr</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="h-resizer"></div>

        <div id="right-panel">
            <div id="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="mb-0 fw-bold ps-1" id="chart-view-title">Chart View</h6>
                    <button class="btn btn-xs btn-outline-primary" onclick="exportView()">üì∑ Export PNG</button>
                </div>
                <div style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 5px; position: relative;">
                    <div id="plotDiv"></div>
                </div>
            </div>

            <div id="v-resizer"></div>

            <div id="table-container">
                <div class="card mb-2 bg-light">
                    <div class="card-body py-1 px-2">
                        <div class="row align-items-center gx-2">
                            <div class="col-auto"><strong class="small">Marker:</strong></div>
                            <div class="col-auto">
                                <input type="number" id="markerXInput" class="form-control form-control-sm" placeholder="X Val" style="width: 80px;" step="0.1">
                            </div>
                            <div class="col-auto">
                                <select id="markerLineSelect" class="form-select form-select-sm" style="width: 150px;"></select>
                            </div>
                            <div class="col">
                                <button class="btn btn-xs btn-dark" onclick="addMarker()">Add</button>
                                <button class="btn btn-xs btn-outline-dark fw-bold" onclick="findMaxMarker()">Max</button>
                                <button class="btn btn-xs btn-outline-dark fw-bold" onclick="findMinMarker()">Min</button>
                                <button class="btn btn-xs btn-danger ms-2" onclick="findOP1dB()">OP1dB</button>
                                <button class="btn btn-xs btn-secondary" onclick="clearMarkers()">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card flex-grow-1" style="border: none; margin-bottom: 0; display: flex; flex-direction: column; overflow: hidden;">
                    <div class="table-responsive bg-white border rounded">
                        <table class="table table-sm mb-0" id="markerTable" style="font-size: 0.85rem;">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Line</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Note</th>
                                    <th>Act</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Rainbow Colors ---
    const rainbowColors = [
        '#FF0000', '#FF7F00', '#FFD700', '#32CD32', '#008000', 
        '#00CED1', '#0000FF', '#4B0082', '#800080', '#FF00FF', 
        '#A52A2A', '#808080'
    ];
    
    let tabsData = {}; 
    let activeTab = null;
    let tabCounter = 0;

    window.onload = function() { createNewTab(); };

    function createNewTab() {
        tabCounter++;
        const tabId = `tab_${Date.now()}`;
        const tabName = `Plot ${tabCounter}`;
        
        let initialRawFiles = []; 
        let initialConfig = { 
            chartTitle: '', xLabel: '', yLabel: '', headerRow: 1, 
            xMin: '', xMax: '', xStep: '', yMin: '', yMax: '', yStep: '', specValue: '', 
            xCol: '', yCol: '' 
        };

        const tabKeys = Object.keys(tabsData);
        if (tabKeys.length > 0) {
            const firstTabId = tabKeys[0];
            const sourceTab = tabsData[firstTabId];
            initialRawFiles = [...sourceTab.rawFiles];
            initialConfig = { ...sourceTab.config };
        }

        tabsData[tabId] = {
            name: tabName,
            rawFiles: initialRawFiles, 
            files: [],
            markers: [],
            sortOrder: 'none',
            config: initialConfig
        };

        const tabList = document.getElementById('tab-list');
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.id = `li-${tabId}`;
        li.innerHTML = `<a class="nav-link" onclick="switchTab('${tabId}')" id="link-${tabId}"><span id="text-${tabId}">${tabName}</span><span class="tab-close-btn" onclick="closeTab(event, '${tabId}')">√ó</span></a>`;
        tabList.appendChild(li);
        
        switchTab(tabId);
        
        if (initialRawFiles.length > 0) {
            reparseCurrentFiles();
        }
    }

    function closeTab(event, tabId) {
        event.stopPropagation();
        if (Object.keys(tabsData).length <= 1) { alert("Cannot close the last tab."); return; }
        if (!confirm(`Delete ${tabsData[tabId].name}?`)) return;
        delete tabsData[tabId];
        document.getElementById(`li-${tabId}`).remove();
        if (activeTab === tabId) switchTab(Object.keys(tabsData)[Object.keys(tabsData).length - 1]);
    }

    function switchTab(tabId) {
        if (activeTab && tabsData[activeTab]) saveConfig();
        activeTab = tabId;

        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        const activeLink = document.getElementById(`link-${tabId}`);
        if (activeLink) activeLink.classList.add('active');

        document.getElementById('csvFileInput').value = '';
        document.getElementById('folderInput').value = ''; 
        
        restoreConfig();
        updateFileTable();
        updateSortIcon();

        if (tabsData[activeTab].files.length > 0) {
            document.getElementById('plotBtn').disabled = false;
            document.getElementById('xColSelect').disabled = false;
            document.getElementById('yColSelect').disabled = false;
            document.getElementById('plotBtn').click();
        } else {
            clearUIForEmpty();
        }
        document.getElementById('chart-view-title').innerText = `Chart View (${tabsData[activeTab].name})`;
    }

    function sortFiles() {
        if (!tabsData[activeTab] || tabsData[activeTab].files.length === 0) return;
        const currentSort = tabsData[activeTab].sortOrder;
        let newSort = (currentSort === 'asc') ? 'desc' : 'asc';
        tabsData[activeTab].sortOrder = newSort;
        const files = tabsData[activeTab].files;
        files.sort((a, b) => {
            const nameA = a.name.toLowerCase();
            const nameB = b.name.toLowerCase();
            const comp = nameA.localeCompare(nameB, undefined, {numeric: true, sensitivity: 'base'});
            return newSort === 'asc' ? comp : -comp;
        });
        updateSortIcon();
        updateFileTable();
        document.getElementById('plotBtn').click();
    }

    function updateSortIcon() {
        const icon = document.getElementById('sortIcon');
        if (!activeTab || !tabsData[activeTab]) return;
        const order = tabsData[activeTab].sortOrder;
        icon.innerText = (order === 'asc') ? '‚ñ≤' : (order === 'desc') ? '‚ñº' : '‚Üï';
    }

    function saveConfig() {
        if (!activeTab || !tabsData[activeTab]) return;
        const config = tabsData[activeTab].config;
        config.chartTitle = document.getElementById('chartTitle').value;
        config.xLabel = document.getElementById('xLabelInput').value; 
        config.yLabel = document.getElementById('yLabelInput').value;
        config.headerRow = document.getElementById('headerRowInput').value; 
        config.xMin = document.getElementById('xMin').value;
        config.xMax = document.getElementById('xMax').value;
        config.xStep = document.getElementById('xStep').value;
        config.yMin = document.getElementById('yMin').value;
        config.yMax = document.getElementById('yMax').value;
        config.yStep = document.getElementById('yStep').value;
        config.specValue = document.getElementById('specInput').value; 
        config.xCol = document.getElementById('xColSelect').value;
        config.yCol = document.getElementById('yColSelect').value;
    }

    function restoreConfig() {
        const config = tabsData[activeTab].config;
        document.getElementById('chartTitle').value = config.chartTitle || '';
        document.getElementById('xLabelInput').value = config.xLabel || '';
        document.getElementById('yLabelInput').value = config.yLabel || '';
        document.getElementById('headerRowInput').value = config.headerRow || '1'; 
        document.getElementById('xMin').value = config.xMin || '';
        document.getElementById('xMax').value = config.xMax || '';
        document.getElementById('xStep').value = config.xStep || '';
        document.getElementById('yMin').value = config.yMin || '';
        document.getElementById('yMax').value = config.yMax || '';
        document.getElementById('yStep').value = config.yStep || '';
        document.getElementById('specInput').value = config.specValue || ''; 
        
        const files = tabsData[activeTab].files;
        const xSelect = document.getElementById('xColSelect');
        const ySelect = document.getElementById('yColSelect');
        xSelect.innerHTML = ''; ySelect.innerHTML = '';

        if (files.length > 0) {
            const columns = Object.keys(files[0].data[0]);
            columns.forEach(col => { xSelect.add(new Option(col, col)); ySelect.add(new Option(col, col)); });
            if (config.xCol) xSelect.value = config.xCol;
            if (config.yCol) ySelect.value = config.yCol;
        }
        document.getElementById('fileCount').innerText = `${files.length} files`;
    }

    function clearUIForEmpty() {
        document.getElementById('fileCount').innerText = "0 files";
        document.getElementById('xColSelect').innerHTML = '';
        document.getElementById('yColSelect').innerHTML = '';
        document.getElementById('xColSelect').disabled = true;
        document.getElementById('yColSelect').disabled = true;
        document.getElementById('plotBtn').disabled = true;
        document.getElementById('fileTable').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('plotDiv').innerHTML = '';
        document.getElementById('markerTable').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('markerLineSelect').innerHTML = '';
    }

    const hResizer = document.getElementById('h-resizer');
    const leftPanel = document.getElementById('left-panel');
    const vResizer = document.getElementById('v-resizer');
    const chartContainer = document.getElementById('chart-container');
    const rightPanel = document.getElementById('right-panel');
    let isResizingH = false, isResizingV = false;

    hResizer.addEventListener('mousedown', () => { isResizingH = true; hResizer.classList.add('resizing'); document.body.classList.add('no-select'); document.body.style.cursor = 'col-resize'; });
    vResizer.addEventListener('mousedown', () => { isResizingV = true; vResizer.classList.add('resizing'); document.body.classList.add('no-select'); document.body.style.cursor = 'row-resize'; });

    window.addEventListener('mousemove', (e) => {
        if (isResizingH) {
            const newWidth = Math.max(200, Math.min(1600, e.clientX));
            leftPanel.style.width = `${newWidth}px`;
            Plotly.Plots.resize(document.getElementById('plotDiv'));
        }
        if (isResizingV) {
            const rect = rightPanel.getBoundingClientRect();
            const relativeY = e.clientY - rect.top;
            const percentage = (relativeY / rect.height) * 100;
            if (percentage > 20 && percentage < 80) {
                chartContainer.style.height = `${percentage}%`;
                Plotly.Plots.resize(document.getElementById('plotDiv'));
            }
        }
    });

    window.addEventListener('mouseup', () => {
        if (isResizingH || isResizingV) {
            isResizingH = false; isResizingV = false;
            hResizer.classList.remove('resizing'); vResizer.classList.remove('resizing');
            document.body.classList.remove('no-select'); document.body.style.cursor = 'default';
            Plotly.Plots.resize(document.getElementById('plotDiv'));
        }
    });

    window.exportView = () => {
        const element = document.getElementById('right-panel');
        html2canvas(element, { backgroundColor: '#ffffff', scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `${tabsData[activeTab].name}_Export.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    };

    function hexToRgba(hex, alpha) {
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            let c = hex.substring(1).split('');
            if(c.length === 3) c = [c[0], c[0], c[1], c[1], c[2], c[2]];
            c = '0x' + c.join('');
            return 'rgba(' + [(c>>16)&255, (c>>8)&255, c&255].join(',') + ',' + alpha + ')';
        }
        return 'rgba(255,255,255,' + alpha + ')';
    }

    // --- FILE INPUT HANDLERS ---
    document.getElementById('csvFileInput').addEventListener('change', function(e) { handleNewFiles(e.target.files, 'file'); });
    document.getElementById('folderInput').addEventListener('change', function(e) { handleNewFiles(e.target.files, 'folder'); });

    function handleNewFiles(fileList, mode) {
        if (!fileList || fileList.length === 0) return;
        const csvFiles = Array.from(fileList).filter(f => f.name.toLowerCase().endsWith('.csv'));
        if (csvFiles.length === 0) { alert("No CSV files found."); return; }
        csvFiles.forEach(f => { f.importMode = mode; });
        tabsData[activeTab].rawFiles = [...tabsData[activeTab].rawFiles, ...csvFiles];
        processFiles(csvFiles);
    }

    function reparseCurrentFiles() {
        if (!activeTab || !tabsData[activeTab]) return;
        const rawFiles = tabsData[activeTab].rawFiles;
        if (rawFiles.length === 0) return;
        tabsData[activeTab].files = [];
        tabsData[activeTab].markers = [];
        processFiles(rawFiles, true);
    }

    function processFiles(filesToProcess, isReparse = false) {
        let filesProcessed = 0;
        const headerRowIndex = (parseInt(document.getElementById('headerRowInput').value) || 1) - 1;
        let filesList = isReparse ? [] : tabsData[activeTab].files; 

        filesToProcess.forEach((file) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split(/\r\n|\n/);
                
                if (lines.length <= headerRowIndex) {
                    filesProcessed++;
                    return;
                }

                const cleanedContent = lines.slice(headerRowIndex).join('\n');

                Papa.parse(cleanedContent, {
                    header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: function(results) {
                        if(results.meta && results.meta.fields && results.meta.fields.length > 0) {
                            let displayName = "";
                            if (file.importMode === 'folder' && file.webkitRelativePath) {
                                displayName = file.webkitRelativePath.replace('.csv', '');
                            } else {
                                displayName = file.name.replace('.csv', '');
                            }

                            let finalName = displayName;
                            let counter = 1;
                            while (filesList.some(f => f.name === finalName)) {
                                finalName = `${displayName} (${counter})`; counter++;
                            }
                            
                            filesList.push({
                                id: Date.now() + Math.random(), name: finalName, originalName: file.name,
                                data: results.data, 
                                color: rainbowColors[filesList.length % rainbowColors.length], 
                                selected: true
                            });
                        }
                        
                        filesProcessed++;
                        if (filesProcessed === filesToProcess.length) {
                            if (isReparse) tabsData[activeTab].files = filesList;
                            
                            if (document.getElementById('xColSelect').options.length === 0 || isReparse) {
                                const xSelect = document.getElementById('xColSelect');
                                const ySelect = document.getElementById('yColSelect');
                                xSelect.innerHTML = ''; ySelect.innerHTML = '';
                                
                                if (filesList.length > 0 && filesList[0].data.length > 0) {
                                    const columns = Object.keys(filesList[0].data[0]);
                                    columns.forEach(col => { xSelect.add(new Option(col, col)); ySelect.add(new Option(col, col)); });
                                    
                                    const savedX = tabsData[activeTab].config.xCol;
                                    const savedY = tabsData[activeTab].config.yCol;
                                    xSelect.value = (savedX && columns.includes(savedX)) ? savedX : (columns.includes('SG_power') ? 'SG_power' : columns[0]);
                                    ySelect.value = (savedY && columns.includes(savedY)) ? savedY : (columns.includes('Gain') ? 'Gain' : (columns[1] || columns[0]));
                                }
                                saveConfig();
                            }
                            
                            document.getElementById('xColSelect').disabled = false;
                            document.getElementById('yColSelect').disabled = false;
                            document.getElementById('plotBtn').disabled = false;
                            document.getElementById('fileCount').innerText = `${filesList.length} files`;
                            
                            updateFileTable();
                            document.getElementById('plotBtn').click();
                        }
                    }
                });
            };
            reader.readAsText(file);
        });
    }

    function clearFiles() {
        tabsData[activeTab].files = []; 
        tabsData[activeTab].rawFiles = []; 
        tabsData[activeTab].markers = []; 
        tabsData[activeTab].config = {}; 
        document.getElementById('csvFileInput').value = '';
        document.getElementById('folderInput').value = ''; 
        clearUIForEmpty();
    }

    function updateFileTable() {
        const files = tabsData[activeTab].files;
        const tbody = document.getElementById('fileTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        files.forEach((file, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="form-check-input" ${file.selected ? 'checked' : ''} onchange="toggleFile(${idx}, this.checked)"></td>
                <td><input type="text" class="form-control form-control-sm border-0 bg-transparent p-0" value="${file.name}" onchange="updateLabel(${idx}, this.value)"></td>
                <td><input type="color" class="form-control form-control-sm form-control-color p-0" value="${file.color}" onchange="updateColor(${idx}, this.value)"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.toggleFile = (idx, checked) => { tabsData[activeTab].files[idx].selected = checked; };
    window.updateLabel = (idx, val) => { 
        const file = tabsData[activeTab].files[idx]; file.name = val;
        tabsData[activeTab].markers.forEach(m => { if(m.fileId === file.id) m.lineName = val; });
        updateLineSelect(); document.getElementById('plotBtn').click(); 
    };
    window.updateColor = (idx, val) => { tabsData[activeTab].files[idx].color = val; document.getElementById('plotBtn').click(); };
    window.toggleAllFiles = (status) => {
        tabsData[activeTab].files.forEach(f => f.selected = status);
        updateFileTable(); document.getElementById('plotBtn').click();
    };

    window.resetMarkersAndPlot = () => {
        tabsData[activeTab].markers = []; document.getElementById('plotBtn').click();
    };

    window.autoScale = () => {
        ['xMin', 'xMax', 'xStep', 'yMin', 'yMax', 'yStep'].forEach(id => document.getElementById(id).value = '');
        saveConfig(); document.getElementById('plotBtn').click();
    };

    document.getElementById('plotBtn').addEventListener('click', function() {
        const files = tabsData[activeTab].files;
        
        const xCol = document.getElementById('xColSelect').value;
        const yCol = document.getElementById('yColSelect').value;
        const chartTitleVal = document.getElementById('chartTitle').value;
        
        const plotTitle = chartTitleVal ? chartTitleVal : `${yCol} vs ${xCol}`;
        
        const xLabelVal = document.getElementById('xLabelInput').value;
        const yLabelVal = document.getElementById('yLabelInput').value;
        const specVal = parseFloat(document.getElementById('specInput').value);

        const getVal = (id) => { const v = document.getElementById(id).value; return v === "" ? null : parseFloat(v); };
        const xMin = getVal('xMin'), xMax = getVal('xMax'), xStep = getVal('xStep');
        const yMin = getVal('yMin'), yMax = getVal('yMax'), yStep = getVal('yStep');

        const traces = [];
        files.forEach(file => {
            if (!file.selected) return;
            const xData = [], yData = [];
            file.data.forEach(row => {
                const xv = row[xCol], yv = row[yCol];
                if (typeof xv === 'number' && typeof yv === 'number') { xData.push(xv); yData.push(yv); }
            });
            const combined = xData.map((x, i) => ({ x, y: yData[i] }));
            combined.sort((a, b) => a.x - b.x);
            file.cacheX = combined.map(d => d.x); file.cacheY = combined.map(d => d.y);
            traces.push({
                x: file.cacheX, y: file.cacheY, mode: 'lines+markers', type: 'scatter',
                name: file.name, line: { color: file.color, width: 2 }, marker: { size: 6 }, customdata: file.id
            });
        });

        const shapes = [];
        if (!isNaN(specVal)) {
            shapes.push({
                type: 'line', xref: 'paper', x0: 0, x1: 1,
                y0: specVal, y1: specVal,
                line: { color: 'black', width: 2, dash: 'dash' }
            });
        }

        const layout = {
            title: { text: plotTitle, font: { size: 18 } },
            xaxis: { title: xLabelVal || xCol, showgrid: true, zeroline: false, range: (xMin!==null && xMax!==null)?[xMin,xMax]:null, dtick: xStep },
            yaxis: { title: yLabelVal || yCol, showgrid: true, zeroline: false, range: (yMin!==null && yMax!==null)?[yMin,yMax]:null, dtick: yStep },
            hovermode: 'closest',
            shapes: shapes, 
            legend: { bgcolor: 'rgba(255,255,255,0.8)', bordercolor: '#E2E2E2', borderwidth: 1 },
            margin: { t: 40, r: 20, l: 50, b: 40 }
        };
        const plotConfig = { responsive: true, editable: true, displayModeBar: true, displaylogo: false };

        updateLineSelect();
        Plotly.newPlot('plotDiv', traces, layout, plotConfig).then(() => {
            const currentMarkers = tabsData[activeTab].markers;
            document.getElementById('markerTable').getElementsByTagName('tbody')[0].innerHTML = '';
            currentMarkers.forEach(m => renderMarker(m));
            document.getElementById('plotDiv').on('plotly_click', function(data){
                const pt = data.points[0];
                document.getElementById('markerXInput').value = pt.x;
                const fileId = pt.data.customdata;
                const file = files.find(f => f.id === fileId);
                const lineName = file ? file.name : pt.data.name;
                addMarkerData(pt.x, pt.y, `M${currentMarkers.length+1}`, lineName, fileId, "Clicked");
            });
        });
    });

    function updateLineSelect() {
        const select = document.getElementById('markerLineSelect');
        const files = tabsData[activeTab].files;
        select.innerHTML = '';
        files.forEach((file, idx) => { if (file.selected) select.add(new Option(file.name, idx)); });
    }

    function interpolate(targetX, xArr, yArr) {
        if (targetX < xArr[0] || targetX > xArr[xArr.length - 1]) return null;
        let i = 0;
        while (i < xArr.length - 1 && xArr[i+1] < targetX) i++;
        const x0 = xArr[i], x1 = xArr[i+1];
        const y0 = yArr[i], y1 = yArr[i+1];
        if (x1 - x0 === 0) return y0;
        return y0 + (targetX - x0) * (y1 - y0) / (x1 - x0);
    }

    window.addMarker = () => {
        const xVal = parseFloat(document.getElementById('markerXInput').value);
        const fIdx = document.getElementById('markerLineSelect').value;
        const files = tabsData[activeTab].files;
        if (!fIdx) { alert("Select a line"); return; }
        const file = files[fIdx];
        if (!file.cacheX) { alert("Plot first"); return; }
        const yVal = interpolate(xVal, file.cacheX, file.cacheY);
        if (yVal === null) { alert("X out of range"); return; }
        addMarkerData(xVal, yVal, `M${tabsData[activeTab].markers.length+1}`, file.name, file.id);
    };

    window.findMaxMarker = () => {
        const fIdx = document.getElementById('markerLineSelect').value;
        const files = tabsData[activeTab].files;
        if (!fIdx) { alert("Select a line"); return; }
        const file = files[fIdx];
        if (!file.cacheX) { alert("Plot first"); return; }
        const maxY = Math.max(...file.cacheY);
        const maxIdx = file.cacheY.indexOf(maxY);
        addMarkerData(file.cacheX[maxIdx], maxY, `Max`, file.name, file.id, "Max Value");
    };

    window.findMinMarker = () => {
        const fIdx = document.getElementById('markerLineSelect').value;
        const files = tabsData[activeTab].files;
        if (!fIdx) { alert("Select a line"); return; }
        const file = files[fIdx];
        if (!file.cacheX) { alert("Plot first"); return; }
        const minY = Math.min(...file.cacheY);
        const minIdx = file.cacheY.indexOf(minY);
        addMarkerData(file.cacheX[minIdx], minY, `Min`, file.name, file.id, "Min Value");
    };

    window.findOP1dB = () => {
        const markers = tabsData[activeTab].markers;
        if (markers.length === 0) { alert("Add reference marker first"); return; }
        const ref = markers[markers.length - 1];
        const file = tabsData[activeTab].files.find(f => f.id === ref.fileId);
        if (!file) { alert("Reference line not found"); return; }
        const targetY = ref.y - 1.0;
        const xArr = file.cacheX;
        let startI = xArr.findIndex(x => x >= ref.x);
        let foundX = null;
        for (let i = startI; i < xArr.length - 1; i++) {
            const y1 = file.cacheY[i], y2 = file.cacheY[i+1];
            if ((y1 - targetY) * (y2 - targetY) <= 0) {
                foundX = xArr[i] + (targetY - y1) * (xArr[i+1] - xArr[i]) / (y2 - y1); break;
            }
        }
        if (foundX !== null) addMarkerData(foundX, targetY, "OP1dB", file.name, file.id, "1dB Drop");
        else alert("OP1dB not found");
    };

    function addMarkerData(x, y, name, lineName, fileId, note="") {
        const mObj = {id: Date.now(), x, y, name, lineName, fileId, note};
        tabsData[activeTab].markers.push(mObj);
        renderMarker(mObj);
    }

    function renderMarker(mObj) {
        Plotly.addTraces('plotDiv', {
            x: [mObj.x], y: [mObj.y], mode: 'markers+text', type: 'scatter',
            marker: { color: 'red', size: 10, symbol: 'circle-open', line: {width: 2} },
            text: [`${mObj.name}<br>${mObj.y.toFixed(2)}`], textposition: 'top center', showlegend: false, hoverinfo: 'text'
        });
        
        const layout = document.getElementById('plotDiv').layout;
        const currentShapes = layout.shapes || [];
        const newShapes = currentShapes.concat([
            { type: 'line', x0: mObj.x, y0: layout.yaxis.range?layout.yaxis.range[0]:0, x1: mObj.x, y1: mObj.y, line: {color:'red', dash:'dot', width:1} },
            { type: 'line', x0: layout.xaxis.range?layout.xaxis.range[0]:0, y0: mObj.y, x1: mObj.x, y1: mObj.y, line: {color:'red', dash:'dot', width:1} }
        ]);
        Plotly.relayout('plotDiv', { shapes: newShapes });

        const file = tabsData[activeTab].files.find(f => f.id === mObj.fileId);
        const bgColor = file ? hexToRgba(file.color, 0.2) : 'rgba(255,255,255,1)';
        const tbody = document.getElementById('markerTable').getElementsByTagName('tbody')[0];
        const tr = document.createElement('tr');
        tr.style.backgroundColor = bgColor;
        tr.innerHTML = `<td>${mObj.name}</td><td>${mObj.lineName}</td><td>${mObj.x.toFixed(2)}</td><td>${mObj.y.toFixed(2)}</td><td>${mObj.note}</td><td><button class="btn btn-xs btn-danger" onclick="removeMarker(${mObj.id})">Del</button></td>`;
        tbody.appendChild(tr);
    }

    window.removeMarker = (id) => {
        tabsData[activeTab].markers = tabsData[activeTab].markers.filter(m => m.id !== id);
        document.getElementById('plotBtn').click();
    };

    window.clearMarkers = () => {
        tabsData[activeTab].markers = []; document.getElementById('plotBtn').click();
    };

</script>

</body>
</html>

