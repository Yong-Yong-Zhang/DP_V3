<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Plotting Tool v5.5 @Yong</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* --- ÂÖ®Â±ÄË®≠ÂÆö --- */
        html { font-size: 115%; }
        body, html { 
            height: 100%; margin: 0; padding: 0; overflow: hidden; 
            background-color: #f8f9fa; 
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
        }
        
        #main-wrapper { display: flex; flex-direction: column; height: 100vh; }

        /* È†ÇÈÉ®Â∞éËà™Âàó */
        #top-nav {
            flex: 0 0 auto;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            padding: 5px 10px 0 10px;
            display: flex; align-items: flex-end;
        }
        .nav-tabs { border-bottom: none; flex-grow: 1; }
        .nav-tabs .nav-item { margin-right: 2px; }
        .nav-tabs .nav-link { 
            cursor: pointer; font-weight: 600; color: #495057; 
            padding: 8px 12px; display: flex; align-items: center; gap: 8px;
        }
        .nav-tabs .nav-link.active { color: #0d6efd; background-color: #f8f9fa; border-color: #ddd #ddd #f8f9fa; }
        .tab-close-btn:hover { background-color: #dc3545; color: white; border-radius: 50%; width: 20px; text-align: center;}
        #add-tab-btn { cursor: pointer; font-weight: bold; padding: 5px 10px; color: #28a745; font-size: 1.2rem; }

        /* --- ÂÖßÂÆπÂçÄÂüü‰ΩàÂ±Ä --- */
        #app-container { display: flex; flex: 1; overflow: hidden; }

        /* Â∑¶ÂÅ¥ÊéßÂà∂Èù¢Êùø */
        #left-panel {
            width: 440px; /* Increased width for new column */
            min-width: 300px; max-width: 1600px;
            background-color: #f8f9fa; border-right: 1px solid #ddd;
            padding: 15px; 
            display: block; 
            overflow-y: auto; 
            height: 100%;
        }

        .series-table-container {
            max-height: 400px; 
            overflow-y: auto;  
            border: 1px solid #dee2e6;
        }

        #h-resizer {
            width: 6px; background-color: #e9ecef; cursor: col-resize; z-index: 10;
            border-left: 1px solid #dee2e6; border-right: 1px solid #dee2e6;
        }

        /* Âè≥ÂÅ¥ÂúñË°®ÂçÄÂüü */
        #right-panel {
            flex-grow: 1; background-color: #ffffff; display: flex;
            flex-direction: column; overflow: hidden; padding: 10px;
        }

        #v-resizer {
            height: 8px; background-color: #e9ecef; cursor: row-resize;
            margin: 5px 0; border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6; flex-shrink: 0;
        }

        #chart-container { height: 60%; min-height: 200px; display: flex; flex-direction: column; }
        #table-container { flex: 1; min-height: 150px; display: flex; flex-direction: column; overflow: hidden; }

        /* Âç°ÁâáÊ®£Âºè */
        .card { margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .card-header { font-weight: 600; padding: 8px 15px; font-size: 0.95rem; }
        .card-body { padding: 12px; }
        
        #plotDiv { width: 100%; height: 100%; background: white; }
        
        .marker-scroll-container {
            position: absolute; top: 0; bottom: 0; left: 0; right: 0; overflow-y: auto;
        }

        .axis-label { font-size: 0.8rem; color: #555; margin-bottom: 2px; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #e9ecef; }
        
        /* Á¢∫‰øùË°®Ê†ºËÉåÊôØËâ≤ËÉΩÈ°ØÁ§∫ */
        #markerTable td, #markerTable th { 
            vertical-align: middle; 
            background-color: transparent !important; 
            padding: 4px 8px; 
        }

        /* Select styling in table */
        .style-select {
            font-size: 0.8rem;
            padding: 0 2px;
            height: 24px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            width: 100%;
            background-color: transparent;
        }

        #drive-config { display: none; background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        
        .form-control-sm, .form-select-sm, .btn-xs { font-size: 0.85rem; }
        .btn-group-xs > .btn, .btn-xs { padding: .25rem .4rem; line-height: 1.5; border-radius: .2rem; }

        /* Modal Image Styling */
        #previewImage {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border: 1px solid #ddd;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<div id="main-wrapper">
    <div id="top-nav">
        <ul class="nav nav-tabs" id="tab-list"></ul>
        <div id="add-tab-btn" onclick="createNewTab()" title="Add New Plot">+</div>
    </div>

    <div id="app-container">
        <div id="left-panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Control Panel <span class="badge bg-secondary fs-6">v5.5</span></h5>
                <small class="text-muted fw-bold" style="font-family: monospace; font-size: 0.9rem;">@Yong</small>
            </div>

            <div class="card">
                <div class="card-header bg-primary text-white">1. File Selection</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="small fw-bold text-muted mb-1">Local Files</label>
                        <input type="file" class="form-control form-control-sm mb-1" id="csvFileInput" multiple accept=".csv">
                        <input type="file" class="form-control form-control-sm" id="folderInput" webkitdirectory directory multiple>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="small fw-bold text-muted">Google Drive</label>
                            <a href="#" onclick="toggleDriveConfig()" style="font-size: 0.75rem;">‚öôÔ∏è API</a>
                        </div>
                        <div id="drive-config">
                            <small class="d-block text-danger mb-2">Requires http://localhost</small>
                            <input type="text" id="gApiKey" class="form-control form-control-sm mb-1" placeholder="API Key">
                            <input type="text" id="gClientId" class="form-control form-control-sm mb-1" placeholder="Client ID">
                            <input type="text" id="gAppId" class="form-control form-control-sm mb-2" placeholder="App ID">
                            <button class="btn btn-xs btn-dark w-100" onclick="saveDriveConfig()">Save Config</button>
                        </div>
                        <button class="btn btn-sm btn-outline-primary w-100" id="drivePickBtn" onclick="handleAuthClick()">üìÇ Google Drive Picker</button>
                        <div id="drive-status" class="small text-muted mt-1 text-center"></div>
                    </div>

                    <div class="d-flex flex-column gap-2 border-top pt-2">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted" id="fileCount">0 files</small>
                            <button class="btn btn-xs btn-outline-danger" onclick="clearFiles()">Clear All</button>
                        </div>
                        <button class="btn btn-sm btn-success w-100" onclick="exportMergedCSV()">
                            üíæ Export Merged CSV (Wide)
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-dark text-white">2. Data Mapping</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="axis-label fw-bold">Header Row</label>
                        <input type="number" id="headerRowInput" class="form-control form-control-sm" value="1" min="1" onchange="reparseCurrentFiles()">
                    </div>
                    <label class="axis-label fw-bold">X-Axis Column</label>
                    <select id="xColSelect" class="form-select form-select-sm mb-2" disabled onchange="saveConfig(); resetMarkersAndPlot()"></select>
                    <label class="axis-label fw-bold">Y-Axis Column</label>
                    <select id="yColSelect" class="form-select form-select-sm" disabled onchange="saveConfig(); resetMarkersAndPlot()"></select>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span>3. Axis & Title</span>
                    <button class="btn btn-xs btn-light py-0 px-2" onclick="autoScale()">Auto</button>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="axis-label">Chart Title</label>
                        <input type="text" id="chartTitle" class="form-control form-control-sm" onchange="saveConfig()">
                    </div>
                    
                    <div class="row g-1 mb-2">
                        <div class="col-6">
                             <label class="axis-label fw-bold text-primary">Global Font (px)</label>
                             <input type="number" id="chartFontSizeInput" class="form-control form-control-sm" value="14" min="8" max="40" onchange="saveConfig()">
                        </div>
                        <div class="col-6">
                             <label class="axis-label fw-bold text-primary">Legend Font (px)</label>
                             <input type="number" id="legendFontSizeInput" class="form-control form-control-sm" value="12" min="8" max="40" onchange="saveConfig()">
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label class="axis-label fw-bold text-dark">Legend Position</label>
                        <select id="legendPosSelect" class="form-select form-select-sm" onchange="saveConfig()">
                            <option value="outside">Outside (Default)</option>
                            <option value="inside-tr">Inside Top-Right</option>
                            <option value="inside-tl">Inside Top-Left</option>
                            <option value="inside-br">Inside Bottom-Right</option>
                            <option value="inside-bl">Inside Bottom-Left</option>
                        </select>
                    </div>

                    <div class="row g-1 mb-2 bg-light border p-1 rounded">
                        <div class="col-12"><small class="fw-bold text-dark">Export Size (px)</small></div>
                        <div class="col-6">
                            <input type="number" id="exportWidthInput" class="form-control form-control-sm" placeholder="W" value="1920" onchange="saveConfig()">
                        </div>
                        <div class="col-6">
                            <input type="number" id="exportHeightInput" class="form-control form-control-sm" placeholder="H" value="1080" onchange="saveConfig()">
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="axis-label fw-bold text-success">Chart Type</label>
                        <select id="chartTypeSelect" class="form-select form-select-sm" onchange="saveConfig()">
                            <option value="lines+markers">Line + Markers (Default)</option>
                            <option value="markers">Scatter (Markers Only)</option>
                            <option value="lines">Line Only</option>
                        </select>
                    </div>
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="distinctModeCheck" checked onchange="saveConfig(); document.getElementById('plotBtn').click();">
                        <label class="form-check-label small fw-bold" for="distinctModeCheck">
                            ‚ú® Auto Markers & Colors (Manual Style)
                        </label>
                    </div>

                    <div class="row g-1 mb-2">
                        <div class="col-6"><input type="text" id="xLabelInput" class="form-control form-control-sm" placeholder="X Label" onchange="saveConfig()"></div>
                        <div class="col-6"><input type="text" id="yLabelInput" class="form-control form-control-sm" placeholder="Y Label" onchange="saveConfig()"></div>
                    </div>

                    <div class="row g-1 mb-1">
                        <div class="col-12"><strong class="axis-label">X Range</strong></div>
                        <div class="col-4"><input type="number" id="xMin" class="form-control form-control-sm" placeholder="Min" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="xMax" class="form-control form-control-sm" placeholder="Max" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="xStep" class="form-control form-control-sm" placeholder="Step" onchange="saveConfig()"></div>
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col-12"><strong class="axis-label">Y Range</strong></div>
                        <div class="col-4"><input type="number" id="yMin" class="form-control form-control-sm" placeholder="Min" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="yMax" class="form-control form-control-sm" placeholder="Max" onchange="saveConfig()"></div>
                        <div class="col-4"><input type="number" id="yStep" class="form-control form-control-sm" placeholder="Step" onchange="saveConfig()"></div>
                    </div>
                    
                    <div class="border-top pt-2 mt-2">
                        <label class="axis-label fw-bold text-danger">Spec Line</label>
                        <input type="number" id="specInput" class="form-control form-control-sm" placeholder="-20" onchange="saveConfig()">
                    </div>

                    <button class="btn btn-sm btn-success w-100 mt-3" id="plotBtn" disabled>Plot / Update</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center py-1">
                    <span>4. Series</span>
                    <div>
                        <button class="btn btn-xs btn-light py-0" onclick="toggleAllFiles(true)">All</button>
                        <button class="btn btn-xs btn-light py-0" onclick="toggleAllFiles(false)">None</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="series-table-container">
                        <table class="table table-sm table-hover mb-0" id="fileTable" style="font-size: 0.9rem;">
                            <thead class="table-light position-sticky top-0 start-0 border-bottom">
                                <tr>
                                    <th width="25"></th>
                                    <th class="sortable-header" onclick="sortFiles()">Label <span id="sortIcon">‚Üï</span></th>
                                    <th width="35">Clr</th>
                                    <th width="75">Style</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="h-resizer"></div>

        <div id="right-panel">
            <div id="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="mb-0 fw-bold ps-1" id="chart-view-title">Chart View</h6>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-dark" onclick="showChartPreview()" title="Preview selected size">
                            üëÅÔ∏è Preview
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle ms-1" data-bs-toggle="dropdown" aria-expanded="false">
                            üì∑ Export PNG
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="exportView('chart')">Only Chart (HQ)</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportView('table')">Only Table</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="exportView('full')">Full View (Chart+Table)</a></li>
                        </ul>
                    </div>
                </div>
                <div style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 5px; position: relative;">
                    <div id="plotDiv"></div>
                </div>
            </div>

            <div id="v-resizer"></div>

            <div id="table-container">
                <div class="card mb-2 bg-light">
                    <div class="card-body py-1 px-2">
                        <div class="row align-items-center gx-2">
                            <div class="col-auto"><strong class="small">Marker:</strong></div>
                            <div class="col-auto"><input type="number" id="markerXInput" class="form-control form-control-sm" placeholder="X Val" style="width: 80px;" step="0.1"></div>
                            <div class="col-auto"><select id="markerLineSelect" class="form-select form-select-sm" style="width: 150px;"></select></div>
                            <div class="col">
                                <button class="btn btn-xs btn-dark" onclick="addMarker()">Add</button>
                                <button class="btn btn-xs btn-outline-dark fw-bold" onclick="findMaxMarker()">Max</button>
                                <button class="btn btn-xs btn-outline-dark fw-bold" onclick="findMinMarker()">Min</button>
                                <button class="btn btn-xs btn-danger ms-2" onclick="findOP1dB()">OP1dB</button>
                                <button class="btn btn-xs btn-secondary" onclick="clearMarkers()">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card flex-grow-1" style="border: none; margin-bottom: 0; position: relative; overflow: hidden;">
                    <div class="marker-scroll-container bg-white border rounded">
                        <table class="table table-sm mb-0" id="markerTable" style="font-size: 0.9rem;">
                            <thead class="table-light position-sticky top-0">
                                <tr>
                                    <th>Name</th>
                                    <th>Line</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Note</th>
                                    <th>Act</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light py-2">
        <h6 class="modal-title fw-bold">Export Preview</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center bg-light" style="overflow: auto;">
        <div id="previewSpinner" class="spinner-border text-primary" role="status" style="display:none;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <img id="previewImage" src="" alt="Preview">
        <div class="mt-2 text-muted small" id="previewDims"></div>
      </div>
      <div class="modal-footer py-1">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-sm btn-primary" onclick="downloadFromPreview()">üíæ Download This Image</button>
      </div>
    </div>
  </div>
</div>

<script>
    // --- FEATURE: UNIQUE COLORS V5.3 (HIGH CONTRAST) ---
    const distinctHexColors = [
        '#FF0000', '#0000FF', '#008000', '#FFD700', '#800080', '#00CED1', '#FF1493', '#8B4513', 
        '#708090', '#DC143C', '#4B0082', '#556B2F', '#00BFFF', '#FFA500', '#FF69B4', '#2E8B57', 
        '#CD5C5C', '#191970', '#808000', '#4682B4', '#DA70D6', '#A0522D', '#2F4F4F', '#FF4500', 
        '#6A5ACD', '#32CD32', '#B22222', '#5F9EA0', '#9932CC', '#D2691E', '#000080', '#ADFF2F', 
        '#FF6347', '#7B68EE', '#3CB371', '#C71585', '#D2B48C', '#6495ED', '#9ACD32', '#800000', 
        '#008B8B', '#BA55D3', '#F4A460', '#4169E1', '#006400', '#E9967A', '#8A2BE2', '#20B2AA', 
        '#DB7093', '#F08080', '#778899', '#B0C4DE', '#FFFF54', '#00FA9A', '#9370DB', '#BC8F8F', 
        '#40E0D0', '#C0C0C0', '#483D8B', '#FF7F50'
    ];
    
    // --- FEATURE: PATTERN CYCLING (v5.5 - Markers Only) ---
    const markerSymbols = ['circle', 'square', 'diamond', 'triangle-up', 'triangle-down', 'cross', 'x', 'star', 'hexagon', 'pentagon', 'hexagram', 'star-square'];

    let tabsData = {}; let activeTab = null; let tabCounter = 0;
    
    // Google Drive Config
    let driveConfig = { apiKey: '', clientId: '', appId: '' };
    let tokenClient, accessToken = null;

    window.onload = function() { 
        createNewTab(); loadDriveConfig();
        if(window.location.protocol === 'file:') {
            document.getElementById('drive-status').innerHTML = '<span class="text-danger fw-bold">‚ö† Warning: Google API requires http://localhost</span>';
            document.getElementById('drivePickBtn').disabled = true;
        }
    };

    // --- Helper: HEX to RGBA ---
    function hexToRgba(hex, alpha) {
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            let c = hex.substring(1).split('');
            if(c.length === 3) c = [c[0], c[0], c[1], c[1], c[2], c[2]];
            c = '0x' + c.join('');
            return 'rgba(' + [(c>>16)&255, (c>>8)&255, c&255].join(',') + ',' + alpha + ')';
        }
        return 'rgba(255,255,255,' + alpha + ')';
    }

    // --- Helper: Generate Distinct Color (HSL -> Hex) ---
    function getDistinctColor(idx) {
        if(idx < distinctHexColors.length) {
            return distinctHexColors[idx];
        }
        const hue = (idx * 137.508) % 360; 
        const lightness = 40 + (idx % 3) * 15;
        return hslToHex(hue, 80, lightness);
    }

    function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
    }

    // --- FEATURE: PREVIEW (v5.0) ---
    window.showChartPreview = async () => {
        const w = parseInt(document.getElementById('exportWidthInput').value) || 1920;
        const h = parseInt(document.getElementById('exportHeightInput').value) || 1080;
        
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        const img = document.getElementById('previewImage');
        const spinner = document.getElementById('previewSpinner');
        const dims = document.getElementById('previewDims');

        img.style.display = 'none';
        spinner.style.display = 'inline-block';
        dims.innerText = `Rendering ${w} x ${h} ...`;
        modal.show();

        try {
            // Use Plotly toImage to generate a Data URL
            const url = await Plotly.toImage('plotDiv', {
                format: 'png',
                width: w,
                height: h
            });
            
            img.src = url;
            img.onload = () => {
                spinner.style.display = 'none';
                img.style.display = 'block';
                dims.innerText = `Dimensions: ${w}px x ${h}px`;
            };
        } catch (e) {
            console.error(e);
            dims.innerText = "Error generating preview.";
            spinner.style.display = 'none';
        }
    };

    window.downloadFromPreview = () => {
        const img = document.getElementById('previewImage');
        if(!img.src) return;
        const link = document.createElement('a');
        link.download = `${tabsData[activeTab].name}_Chart_${document.getElementById('exportWidthInput').value}x${document.getElementById('exportHeightInput').value}.png`;
        link.href = img.src;
        link.click();
    };

    // --- FEATURE: ULTRA-ROBUST EXPORT (v4.9) ---
    window.exportView = (mode) => {
        // --- ÈáùÂ∞ç "Only Chart" ‰ΩøÁî® Plotly ÂéüÁîü‰∏ãËºâ (ÊîØÊè¥Ëá™Ë®ÇÂ∞∫ÂØ∏) ---
        if (mode === 'chart') {
            const w = parseInt(document.getElementById('exportWidthInput').value) || 1920;
            const h = parseInt(document.getElementById('exportHeightInput').value) || 1080;
            const fileName = `${tabsData[activeTab].name}_Chart`;

            Plotly.downloadImage('plotDiv', {
                format: 'png', 
                width: w, 
                height: h, 
                filename: fileName
            });
            return; // ÁµêÊùüÔºå‰∏çÂü∑Ë°å‰∏ãÊñπÁöÑ html2canvas
        }

        // --- ÈáùÂ∞ç "Table" Êàñ "Full" ÁπºÁ∫å‰ΩøÁî® html2canvas ---
        const btn = document.querySelector('.dropdown-toggle');
        const originalText = btn.innerText;
        btn.innerText = "Processing...";

        const rightPanel = document.getElementById('right-panel');
        const chartContainer = document.getElementById('chart-container');
        const tableContainer = document.getElementById('table-container');
        const tableScroll = document.querySelector('.marker-scroll-container');
        const mainWrapper = document.getElementById('main-wrapper');
        const appContainer = document.getElementById('app-container');
        
        const targetId = (mode === 'table' ? 'table-container' : 'right-panel');
        const targetElement = document.getElementById(targetId);

        // Snapshot original styles
        const styles = {
            html: { height: document.documentElement.style.height, overflow: document.documentElement.style.overflow },
            body: { height: document.body.style.height, overflow: document.body.style.overflow },
            mw: { height: mainWrapper.style.height, overflow: mainWrapper.style.overflow },
            app: { height: appContainer.style.height, overflow: appContainer.style.overflow },
            rp: { height: rightPanel.style.height, overflow: rightPanel.style.overflow },
            cc: { height: chartContainer.style.height, flex: chartContainer.style.flex },
            tc: { height: tableContainer.style.height, flex: tableContainer.style.flex, overflow: tableContainer.style.overflow },
            ts: { position: tableScroll.style.position, overflow: tableScroll.style.overflow, height: tableScroll.style.height }
        };

        if (mode !== 'chart') {
            // 1. Lock Chart Height to prevent shrinking/disappearing
            const currentChartHeight = chartContainer.offsetHeight;
            chartContainer.style.flex = 'none';
            chartContainer.style.height = `${currentChartHeight}px`;

            // 2. Remove SCROLL restrictions globally
            // This forces the "scrollable" inner divs to push the body size
            document.documentElement.style.height = 'auto';
            document.documentElement.style.overflow = 'visible';
            document.body.style.height = 'auto';
            document.body.style.overflow = 'visible';
            mainWrapper.style.height = 'auto';
            mainWrapper.style.overflow = 'visible';
            appContainer.style.height = 'auto';
            appContainer.style.overflow = 'visible';
            rightPanel.style.height = 'auto';
            rightPanel.style.overflow = 'visible';

            // 3. Expand the Table
            tableScroll.style.position = 'static'; // Crucial: removes absolute constraint
            tableScroll.style.overflow = 'visible';
            tableScroll.style.height = 'auto';
            
            tableContainer.style.flex = 'none'; 
            tableContainer.style.height = 'auto'; 
            tableContainer.style.overflow = 'visible';
        }

        setTimeout(() => {
            // 4. Capture with explicit size params
            // We calculate the FULL expanded height of the target
            const fullHeight = targetElement.scrollHeight;
            
            html2canvas(targetElement, { 
                backgroundColor: '#ffffff', 
                scale: 2,
                height: fullHeight, // Force canvas to capture full height
                windowHeight: fullHeight // Pretend the window is massive
            }).then(canvas => {
                // 5. Restore Original Styles
                if (mode !== 'chart') {
                    document.documentElement.style.height = styles.html.height; document.documentElement.style.overflow = styles.html.overflow;
                    document.body.style.height = styles.body.height; document.body.style.overflow = styles.body.overflow;
                    mainWrapper.style.height = styles.mw.height; mainWrapper.style.overflow = styles.mw.overflow;
                    appContainer.style.height = styles.app.height; appContainer.style.overflow = styles.app.overflow;
                    rightPanel.style.height = styles.rp.height; rightPanel.style.overflow = styles.rp.overflow;
                    chartContainer.style.height = styles.cc.height; chartContainer.style.flex = styles.cc.flex;
                    tableContainer.style.height = styles.tc.height; tableContainer.style.flex = styles.tc.flex; tableContainer.style.overflow = styles.tc.overflow;
                    tableScroll.style.position = styles.ts.position; tableScroll.style.overflow = styles.ts.overflow; tableScroll.style.height = styles.ts.height;
                }
                
                const link = document.createElement('a');
                link.download = `${tabsData[activeTab].name}_${mode === 'table' ? 'Table' : 'FullView'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.innerText = originalText;
            }).catch(e => {
                console.error(e);
                btn.innerText = "Error";
            });
        }, 100); 
    };

    window.exportMergedCSV = () => {
        if (!tabsData[activeTab] || tabsData[activeTab].files.length === 0) {
            alert("No files to export."); return;
        }
        const files = tabsData[activeTab].files.filter(f => f.selected);
        if (files.length === 0) { alert("No files selected."); return; }
        const config = tabsData[activeTab].config;
        const xColName = config.xCol;
        let xMap = new Map();
        files.forEach((file, fIdx) => {
            const cols = Object.keys(file.data[0]);
            if (!cols.includes(config.xCol) || !cols.includes(config.yCol)) return;
            file.data.forEach(row => {
                const x = row[config.xCol];
                const y = row[config.yCol];
                if (x !== undefined && y !== undefined && x !== null && y !== null && x !== "" && y !== "") {
                    if (!xMap.has(x)) xMap.set(x, {});
                    xMap.get(x)[fIdx] = y;
                }
            });
        });
        const sortedX = Array.from(xMap.keys()).sort((a, b) => a - b);
        let csvContent = `"${xColName}"`; 
        files.forEach(f => { csvContent += `,"${f.name.replace(/"/g, '""')}"`; });
        csvContent += "\n";
        sortedX.forEach(x => {
            let rowStr = `${x}`;
            const rowData = xMap.get(x);
            for (let i = 0; i < files.length; i++) {
                const val = rowData[i];
                rowStr += `,${val !== undefined ? val : ''}`;
            }
            csvContent += rowStr + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${tabsData[activeTab].name}_Merged_Wide.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // --- Core Functions ---
    function toggleDriveConfig() {
        const div = document.getElementById('drive-config');
        div.style.display = (div.style.display === 'none' || div.style.display === '') ? 'block' : 'none';
    }
    function saveDriveConfig() {
        driveConfig.apiKey = document.getElementById('gApiKey').value;
        driveConfig.clientId = document.getElementById('gClientId').value;
        driveConfig.appId = document.getElementById('gAppId').value;
        localStorage.setItem('drive_cfg', JSON.stringify(driveConfig));
        alert("Config saved! Refresh required.");
        toggleDriveConfig(); loadGapi();
    }
    function loadDriveConfig() {
        const saved = localStorage.getItem('drive_cfg');
        if(saved) {
            driveConfig = JSON.parse(saved);
            document.getElementById('gApiKey').value = driveConfig.apiKey;
            document.getElementById('gClientId').value = driveConfig.clientId;
            document.getElementById('gAppId').value = driveConfig.appId;
            if(driveConfig.apiKey) loadGapi();
        }
    }
    function loadGapi() { if(driveConfig.apiKey) gapi.load('client:picker', initializePicker); }
    async function initializePicker() {
        await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: driveConfig.clientId, scope: 'https://www.googleapis.com/auth/drive.readonly', callback: '', 
        });
        document.getElementById('drive-status').innerText = "API Ready";
    }
    function handleAuthClick() {
        if(!driveConfig.apiKey) { alert("Setup API first."); return; }
        tokenClient.callback = async (resp) => {
            if (resp.error) throw (resp);
            accessToken = resp.access_token; createPicker();
        };
        tokenClient.requestAccessToken({prompt: ''});
    }
    function createPicker() {
        const view = new google.picker.View(google.picker.ViewId.DOCS);
        view.setMimeTypes("text/csv");
        const picker = new google.picker.PickerBuilder()
            .enableFeature(google.picker.Feature.NAV_HIDDEN).enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
            .setDeveloperKey(driveConfig.apiKey).setAppId(driveConfig.appId).setOAuthToken(accessToken)
            .addView(view).setCallback(pickerCallback).build();
        picker.setVisible(true);
    }
    async function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
            const docs = data[google.picker.Document.DOCUMENTS];
            document.getElementById('drive-status').innerText = `Loading ${docs.length}...`;
            let files = [];
            for(let doc of docs) {
                try {
                    const res = await gapi.client.drive.files.get({ fileId: doc[google.picker.Document.ID], alt: 'media' });
                    files.push({ name: doc[google.picker.Document.NAME], content: res.body, importMode: 'drive' });
                } catch(e) { console.error(e); }
            }
            handleDriveFiles(files);
            document.getElementById('drive-status').innerText = "Done.";
        }
    }

    function getSyncColor(name, idx) {
        const keys = Object.keys(tabsData);
        if (keys.length > 0) {
            const match = tabsData[keys[0]].files.find(f => f.originalName === name || f.name === name.replace('.csv',''));
            if (match) return match.color;
        }
        return getDistinctColor(idx); // Use new distinct color generator
    }

    function handleDriveFiles(filesObjList) {
        const headerRow = (parseInt(document.getElementById('headerRowInput').value) || 1) - 1;
        let filesList = tabsData[activeTab].files;
        filesObjList.forEach(obj => {
            const lines = obj.content.split(/\r\n|\n/);
            if (lines.length <= headerRow) return;
            Papa.parse(lines.slice(headerRow).join('\n'), {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: function(res) {
                    if(res.meta.fields && res.meta.fields.length > 0) {
                        let fName = obj.name.replace('.csv', '');
                        let c = 1;
                        while (filesList.some(f => f.name === fName)) { fName = `${obj.name.replace('.csv', '')} (${c})`; c++; }
                        filesList.push({
                            id: Date.now() + Math.random(), name: fName, originalName: obj.name,
                            data: res.data, color: getSyncColor(obj.name, filesList.length), selected: true, dash: 'solid'
                        });
                        finishProcessing(null);
                    }
                }
            });
        });
    }

    function createNewTab() {
        tabCounter++;
        const tabId = `tab_${Date.now()}`;
        let files = [], config = { fontSize: 14, legendFontSize: 12, headerRow: 1, chartType: 'lines+markers' };
        
        if (Object.keys(tabsData).length > 0) {
            const src = tabsData[Object.keys(tabsData)[0]];
            files = [...src.rawFiles]; config = { ...src.config };
        }
        tabsData[tabId] = { name: `Plot ${tabCounter}`, rawFiles: files, files: [], markers: [], sortOrder: 'none', config: config };
        
        const li = document.createElement('li'); li.className = 'nav-item'; li.id = `li-${tabId}`;
        li.innerHTML = `<a class="nav-link" onclick="switchTab('${tabId}')" id="link-${tabId}"><span id="text-${tabId}">${tabsData[tabId].name}</span><span class="tab-close-btn" onclick="closeTab(event, '${tabId}')">√ó</span></a>`;
        document.getElementById('tab-list').appendChild(li);
        switchTab(tabId);
        if (files.length > 0) reparseCurrentFiles();
    }

    function closeTab(e, id) {
        e.stopPropagation();
        if (Object.keys(tabsData).length <= 1) { alert("Last tab."); return; }
        if (!confirm("Delete tab?")) return;
        delete tabsData[id]; document.getElementById(`li-${id}`).remove();
        if (activeTab === id) switchTab(Object.keys(tabsData)[Object.keys(tabsData).length - 1]);
    }

    function switchTab(id) {
        if (activeTab && tabsData[activeTab]) saveConfig();
        activeTab = id;
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById(`link-${id}`).classList.add('active');
        restoreConfig(); updateFileTable(); 
        if (tabsData[activeTab].files.length > 0) {
            document.getElementById('plotBtn').disabled = false;
            document.getElementById('xColSelect').disabled = false; document.getElementById('yColSelect').disabled = false;
            document.getElementById('plotBtn').click();
        } else clearUIForEmpty();
        document.getElementById('chart-view-title').innerText = `Chart View (${tabsData[activeTab].name})`;
    }

    function saveConfig() {
        if (!activeTab) return;
        const c = tabsData[activeTab].config;
        c.chartTitle = document.getElementById('chartTitle').value;
        c.fontSize = document.getElementById('chartFontSizeInput').value;
        c.legendFontSize = document.getElementById('legendFontSizeInput').value;
        c.exportW = document.getElementById('exportWidthInput').value;
        c.exportH = document.getElementById('exportHeightInput').value;
        c.legendPos = document.getElementById('legendPosSelect').value; 
        
        // Save Distinct Mode
        c.distinctMode = document.getElementById('distinctModeCheck').checked;

        c.chartType = document.getElementById('chartTypeSelect').value;
        c.xLabel = document.getElementById('xLabelInput').value; c.yLabel = document.getElementById('yLabelInput').value;
        c.headerRow = document.getElementById('headerRowInput').value;
        c.xMin = document.getElementById('xMin').value; c.xMax = document.getElementById('xMax').value; c.xStep = document.getElementById('xStep').value;
        c.yMin = document.getElementById('yMin').value; c.yMax = document.getElementById('yMax').value; c.yStep = document.getElementById('yStep').value;
        c.specValue = document.getElementById('specInput').value;
        c.xCol = document.getElementById('xColSelect').value; c.yCol = document.getElementById('yColSelect').value;
    }

    function restoreConfig() {
        const c = tabsData[activeTab].config;
        document.getElementById('chartTitle').value = c.chartTitle || '';
        document.getElementById('chartFontSizeInput').value = c.fontSize || 14;
        document.getElementById('legendFontSizeInput').value = c.legendFontSize || 12;
        
        document.getElementById('exportWidthInput').value = c.exportW || 1920;
        document.getElementById('exportHeightInput').value = c.exportH || 1080;
        document.getElementById('legendPosSelect').value = c.legendPos || 'outside'; 
        
        // Restore Distinct Mode
        document.getElementById('distinctModeCheck').checked = (c.distinctMode !== undefined) ? c.distinctMode : true;

        document.getElementById('chartTypeSelect').value = c.chartType || 'lines+markers';
        document.getElementById('xLabelInput').value = c.xLabel || ''; document.getElementById('yLabelInput').value = c.yLabel || '';
        document.getElementById('headerRowInput').value = c.headerRow || 1;
        document.getElementById('xMin').value = c.xMin || ''; document.getElementById('xMax').value = c.xMax || ''; document.getElementById('xStep').value = c.xStep || '';
        document.getElementById('yMin').value = c.yMin || ''; document.getElementById('yMax').value = c.yMax || ''; document.getElementById('yStep').value = c.yStep || '';
        document.getElementById('specInput').value = c.specValue || '';
        
        const xSel = document.getElementById('xColSelect'); const ySel = document.getElementById('yColSelect');
        xSel.innerHTML = ''; ySel.innerHTML = '';
        const files = tabsData[activeTab].files;
        if (files.length > 0) {
            Object.keys(files[0].data[0]).forEach(k => { xSel.add(new Option(k,k)); ySel.add(new Option(k,k)); });
            if (c.xCol) xSel.value = c.xCol; if (c.yCol) ySel.value = c.yCol;
        }
        document.getElementById('fileCount').innerText = `${files.length} files`;
    }

    function clearUIForEmpty() {
        document.getElementById('fileCount').innerText = "0 files";
        document.getElementById('xColSelect').innerHTML = ''; document.getElementById('yColSelect').innerHTML = '';
        document.getElementById('xColSelect').disabled = true; document.getElementById('yColSelect').disabled = true;
        document.getElementById('plotBtn').disabled = true;
        document.querySelector('#fileTable tbody').innerHTML = ''; document.getElementById('plotDiv').innerHTML = '';
        document.querySelector('#markerTable tbody').innerHTML = ''; document.getElementById('markerLineSelect').innerHTML = '';
    }

    // --- Resizers ---
    const hRes = document.getElementById('h-resizer'); const leftP = document.getElementById('left-panel');
    const vRes = document.getElementById('v-resizer'); const rightP = document.getElementById('right-panel'); const chartC = document.getElementById('chart-container');
    let isResH = false, isResV = false;

    hRes.addEventListener('mousedown', () => { isResH = true; document.body.style.cursor = 'col-resize'; });
    vRes.addEventListener('mousedown', () => { isResV = true; document.body.style.cursor = 'row-resize'; });
    window.addEventListener('mousemove', (e) => {
        if (isResH) { leftP.style.width = `${Math.max(250, Math.min(1600, e.clientX))}px`; Plotly.Plots.resize('plotDiv'); }
        if (isResV) { 
            const rect = rightP.getBoundingClientRect();
            const pct = ((e.clientY - rect.top) / rect.height) * 100;
            if(pct > 20 && pct < 80) { chartC.style.height = `${pct}%`; Plotly.Plots.resize('plotDiv'); }
        }
    });
    window.addEventListener('mouseup', () => { isResH = false; isResV = false; document.body.style.cursor = 'default'; });

    // --- File Handling ---
    document.getElementById('csvFileInput').addEventListener('change', (e) => handleNewFiles(e.target.files, 'file'));
    document.getElementById('folderInput').addEventListener('change', (e) => handleNewFiles(e.target.files, 'folder'));

    function handleNewFiles(list, mode) {
        if(!list.length) return;
        const csvs = Array.from(list).filter(f => f.name.toLowerCase().endsWith('.csv'));
        if(!csvs.length) { alert("No CSVs."); return; }
        csvs.forEach(f => f.importMode = mode);
        tabsData[activeTab].rawFiles = [...tabsData[activeTab].rawFiles, ...csvs];
        processFiles(csvs);
    }

    function reparseCurrentFiles() {
        if (!tabsData[activeTab].rawFiles.length) return;
        tabsData[activeTab].files = []; tabsData[activeTab].markers = [];
        processFiles(tabsData[activeTab].rawFiles, true);
    }

    function processFiles(list, isReparse=false) {
        let processed = 0;
        const headerRow = (parseInt(document.getElementById('headerRowInput').value) || 1) - 1;
        let targetList = isReparse ? [] : tabsData[activeTab].files;

        list.forEach(file => {
            const r = new FileReader();
            r.onload = (e) => {
                const lines = e.target.result.split(/\r\n|\n/);
                if(lines.length > headerRow) {
                    Papa.parse(lines.slice(headerRow).join('\n'), {
                        header: true, dynamicTyping: true, skipEmptyLines: true,
                        complete: (res) => {
                            if(res.meta.fields && res.meta.fields.length) {
                                let name = (file.importMode === 'folder' && file.webkitRelativePath) ? file.webkitRelativePath.replace('.csv','') : file.name.replace('.csv','');
                                let final = name, c = 1;
                                while(targetList.some(f => f.name === final)) { final = `${name} (${c})`; c++; }
                                targetList.push({
                                    id: Date.now()+Math.random(), name: final, originalName: file.name,
                                    data: res.data, color: getSyncColor(file.name, targetList.length), selected: true, dash: 'solid'
                                });
                            }
                            processed++;
                            if(processed === list.length) finishProcessing(isReparse ? targetList : null);
                        }
                    });
                } else { processed++; if(processed === list.length) finishProcessing(isReparse ? targetList : null); }
            };
            r.readAsText(file);
        });
    }

    function finishProcessing(newList) {
        if(newList) tabsData[activeTab].files = newList;
        const list = tabsData[activeTab].files;
        if(document.getElementById('xColSelect').options.length === 0 || newList) {
            const xS = document.getElementById('xColSelect'), yS = document.getElementById('yColSelect');
            xS.innerHTML = ''; yS.innerHTML = '';
            if(list.length && list[0].data.length) {
                Object.keys(list[0].data[0]).forEach(k => { xS.add(new Option(k,k)); yS.add(new Option(k,k)); });
                const cfg = tabsData[activeTab].config;
                xS.value = (cfg.xCol && Object.keys(list[0].data[0]).includes(cfg.xCol)) ? cfg.xCol : Object.keys(list[0].data[0])[0];
                yS.value = (cfg.yCol && Object.keys(list[0].data[0]).includes(cfg.yCol)) ? cfg.yCol : (Object.keys(list[0].data[0])[1] || Object.keys(list[0].data[0])[0]);
            }
            saveConfig();
        }
        document.getElementById('xColSelect').disabled = false; document.getElementById('yColSelect').disabled = false;
        document.getElementById('plotBtn').disabled = false;
        document.getElementById('fileCount').innerText = `${list.length} files`;
        updateFileTable(); document.getElementById('plotBtn').click();
    }

    function clearFiles() {
        tabsData[activeTab].files = []; tabsData[activeTab].rawFiles = []; tabsData[activeTab].markers = []; tabsData[activeTab].config = {};
        document.getElementById('csvFileInput').value = ''; document.getElementById('folderInput').value = '';
        clearUIForEmpty();
    }

    function updateFileTable() {
        const tbody = document.querySelector('#fileTable tbody'); tbody.innerHTML = '';
        tabsData[activeTab].files.forEach((f, i) => {
            const tr = document.createElement('tr');
            // FEATURE: Added Style Select Column
            tr.innerHTML = `<td><input type="checkbox" class="form-check-input" ${f.selected?'checked':''} onchange="toggleFile(${i},this.checked)"></td>
                            <td><input type="text" class="form-control form-control-sm border-0 bg-transparent p-0" value="${f.name}" onchange="updateLabel(${i},this.value)"></td>
                            <td><input type="color" class="form-control form-control-sm form-control-color p-0" value="${f.color}" onchange="updateColor(${i},this.value)"></td>
                            <td>
                                <select class="style-select" onchange="updateLineStyle(${i}, this.value)">
                                    <option value="solid" ${f.dash==='solid'?'selected':''}>Solid</option>
                                    <option value="dash" ${f.dash==='dash'?'selected':''}>Dash</option>
                                    <option value="dot" ${f.dash==='dot'?'selected':''}>Dot</option>
                                    <option value="dashdot" ${f.dash==='dashdot'?'selected':''}>DashDot</option>
                                    <option value="longdash" ${f.dash==='longdash'?'selected':''}>Long</option>
                                </select>
                            </td>`;
            tbody.appendChild(tr);
        });
    }

    window.toggleFile = (i, v) => { tabsData[activeTab].files[i].selected = v; };
    window.updateLabel = (i, v) => { 
        tabsData[activeTab].files[i].name = v; 
        tabsData[activeTab].markers.forEach(m => { if(m.fileId === tabsData[activeTab].files[i].id) m.lineName = v; });
        updateLineSelect(); document.getElementById('plotBtn').click(); 
    };
    window.updateColor = (i, v) => { tabsData[activeTab].files[i].color = v; document.getElementById('plotBtn').click(); };
    window.updateLineStyle = (i, v) => { tabsData[activeTab].files[i].dash = v; document.getElementById('plotBtn').click(); };
    window.toggleAllFiles = (v) => { tabsData[activeTab].files.forEach(f => f.selected = v); updateFileTable(); document.getElementById('plotBtn').click(); };
    window.sortFiles = () => {
        const o = tabsData[activeTab].sortOrder === 'asc' ? 'desc' : 'asc'; tabsData[activeTab].sortOrder = o;
        tabsData[activeTab].files.sort((a,b) => o==='asc' ? a.name.localeCompare(b.name,undefined,{numeric:true}) : b.name.localeCompare(a.name,undefined,{numeric:true}));
        document.getElementById('sortIcon').innerText = o==='asc' ? '‚ñ≤' : '‚ñº'; updateFileTable(); document.getElementById('plotBtn').click();
    };

    document.getElementById('plotBtn').addEventListener('click', () => {
        const files = tabsData[activeTab].files;
        const xc = document.getElementById('xColSelect').value, yc = document.getElementById('yColSelect').value;
        const fs = parseInt(document.getElementById('chartFontSizeInput').value) || 14;
        const lfs = parseInt(document.getElementById('legendFontSizeInput').value) || 12; 
        const chartType = document.getElementById('chartTypeSelect').value || 'lines+markers';
        const legPos = document.getElementById('legendPosSelect').value;
        const useDistinct = document.getElementById('distinctModeCheck').checked;

        let traces = [], shapes = [];
        let visibleIdx = 0; // Counter for visible traces to assign cycle styles correctly

        files.forEach(f => {
            if(!f.selected) return;
            let xd = [], yd = [];
            f.data.forEach(r => { if(typeof r[xc]==='number' && typeof r[yc]==='number') { xd.push(r[xc]); yd.push(r[yc]); } });
            let combo = xd.map((x,i) => ({x, y:yd[i]})).sort((a,b) => a.x - b.x);
            f.cacheX = combo.map(d=>d.x); f.cacheY = combo.map(d=>d.y);

            // --- PATTERN LOGIC V5.5 ---
            // Dash: controlled manually (default 'solid')
            let lineStyle = f.dash || 'solid'; 
            
            // Markers: cycled if distinct mode is on
            let markerSymbol = 'circle';
            if (useDistinct) {
                markerSymbol = markerSymbols[visibleIdx % markerSymbols.length];
            }

            traces.push({ 
                x: f.cacheX, y: f.cacheY, 
                mode: chartType, 
                type: 'scatter', 
                name: f.name, 
                line: {
                    color: f.color, 
                    width: useDistinct ? 2.5 : 2, 
                    dash: lineStyle // Manual style overrides auto logic
                }, 
                marker: {
                    size: useDistinct ? 7 : 6, 
                    symbol: markerSymbol
                }, 
                customdata: f.id 
            });
            visibleIdx++;
        });

        const sv = parseFloat(document.getElementById('specInput').value);
        if(!isNaN(sv)) shapes.push({ type: 'line', xref: 'paper', x0: 0, x1: 1, y0: sv, y1: sv, line: {color: 'black', width: 2, dash: 'dash'} });

        // Legend Layout Logic
        let legendLayout = { bgcolor: 'rgba(255,255,255,0.6)', borderwidth: 0, font: {size: lfs}, itemsizing: 'constant' };
        if (legPos === 'inside-tr') { Object.assign(legendLayout, { x: 0.99, y: 0.99, xanchor: 'right', yanchor: 'top' }); }
        else if (legPos === 'inside-tl') { Object.assign(legendLayout, { x: 0.01, y: 0.99, xanchor: 'left', yanchor: 'top' }); }
        else if (legPos === 'inside-br') { Object.assign(legendLayout, { x: 0.99, y: 0.01, xanchor: 'right', yanchor: 'bottom' }); }
        else if (legPos === 'inside-bl') { Object.assign(legendLayout, { x: 0.01, y: 0.01, xanchor: 'left', yanchor: 'bottom' }); }

        const layout = {
            title: { text: document.getElementById('chartTitle').value || `${yc} vs ${xc}`, font: {size: Math.round(fs*1.3)} },
            xaxis: { 
                title: {text: document.getElementById('xLabelInput').value||xc, font:{size:fs}}, 
                tickfont:{size:fs-2}, range: getRange('x'), dtick: getVal('xStep'),
                zeroline: false, zerolinecolor: 'rgba(0,0,0,0)', zerolinewidth: 0,
                showline: true, mirror: true
            },
            yaxis: { 
                title: {text: document.getElementById('yLabelInput').value||yc, font:{size:fs}}, 
                tickfont:{size:fs-2}, range: getRange('y'), dtick: getVal('yStep'),
                zeroline: false, zerolinecolor: 'rgba(0,0,0,0)', zerolinewidth: 0,
                showline: true, mirror: true
            },
            hovermode: 'closest', shapes: shapes,
            legend: legendLayout,
            margin: { t: 50, r: 20, l: 60, b: 50 }
        };
        updateLineSelect();
        Plotly.newPlot('plotDiv', traces, layout, {responsive: true, editable: true, displaylogo: false}).then(() => {
            const markers = tabsData[activeTab].markers;
            document.querySelector('#markerTable tbody').innerHTML = '';
            markers.forEach(m => renderMarker(m));
            document.getElementById('plotDiv').on('plotly_click', (d) => {
                const pt = d.points[0]; document.getElementById('markerXInput').value = pt.x;
                const f = files.find(x => x.id === pt.data.customdata);
                addMarkerData(pt.x, pt.y, `M${markers.length+1}`, f ? f.name : pt.data.name, f?f.id:null, "Clicked");
            });
        });
    });

    function getVal(id) { const v = document.getElementById(id).value; return v==="" ? null : parseFloat(v); }
    function getRange(axis) { const min = getVal(`${axis}Min`), max = getVal(`${axis}Max`); return (min!==null && max!==null) ? [min, max] : null; }
    function updateLineSelect() {
        const sel = document.getElementById('markerLineSelect'); sel.innerHTML = '';
        tabsData[activeTab].files.forEach((f, i) => { if(f.selected) sel.add(new Option(f.name, i)); });
    }

    // --- Markers ---
    function interpolate(tx, xa, ya) {
        if(tx < xa[0] || tx > xa[xa.length-1]) return null;
        let i = xa.findIndex(x => x >= tx);
        if(i === 0) return ya[0];
        const x0 = xa[i-1], x1 = xa[i], y0 = ya[i-1], y1 = ya[i];
        return y0 + (tx - x0) * (y1 - y0) / (x1 - x0);
    }
    
    window.addMarker = () => {
        const x = parseFloat(document.getElementById('markerXInput').value);
        const idx = document.getElementById('markerLineSelect').value;
        if(!idx) { alert("Select line"); return; }
        const f = tabsData[activeTab].files[idx];
        if(!f.cacheX) { alert("Plot first"); return; }
        const y = interpolate(x, f.cacheX, f.cacheY);
        if(y === null) { alert("X out of range"); return; }
        addMarkerData(x, y, `M${tabsData[activeTab].markers.length+1}`, f.name, f.id);
    };

    window.findMaxMarker = () => { markerOp('max'); }; window.findMinMarker = () => { markerOp('min'); };
    function markerOp(type) {
        const idx = document.getElementById('markerLineSelect').value;
        if(!idx) return; const f = tabsData[activeTab].files[idx];
        if(!f.cacheX) return;
        const val = type === 'max' ? Math.max(...f.cacheY) : Math.min(...f.cacheY);
        const i = f.cacheY.indexOf(val);
        addMarkerData(f.cacheX[i], val, type==='max'?'Max':'Min', f.name, f.id, `${type} value`);
    }
    
    window.findOP1dB = () => {
        const ms = tabsData[activeTab].markers;
        if(!ms.length) { alert("Add ref marker"); return; }
        const ref = ms[ms.length-1], f = tabsData[activeTab].files.find(x => x.id === ref.fileId);
        if(!f) return;
        const ty = ref.y - 1.0;
        let start = f.cacheX.findIndex(x => x >= ref.x), foundX = null;
        for(let i=start; i<f.cacheX.length-1; i++) {
            if((f.cacheY[i]-ty)*(f.cacheY[i+1]-ty) <= 0) {
                foundX = f.cacheX[i] + (ty - f.cacheY[i]) * (f.cacheX[i+1] - f.cacheX[i]) / (f.cacheY[i+1] - f.cacheY[i]); break;
            }
        }
        if(foundX!==null) addMarkerData(foundX, ty, "OP1dB", f.name, f.id, "1dB Drop"); else alert("Not found");
    };

    function addMarkerData(x, y, name, line, fid, note="") {
        const m = {id: Date.now(), x, y, name, lineName: line, fileId: fid, note};
        tabsData[activeTab].markers.push(m); renderMarker(m);
    }

    function renderMarker(m) {
        Plotly.addTraces('plotDiv', {
            x: [m.x], y: [m.y], mode: 'markers+text', type: 'scatter',
            marker: {color: 'red', size: 10, symbol: 'circle-open', line: {width: 2}},
            text: [`${m.name}<br>${m.y.toFixed(2)}`], textposition: 'top center', showlegend: false, hoverinfo: 'text'
        });
        const l = document.getElementById('plotDiv').layout;
        const ns = (l.shapes||[]).concat([
            {type: 'line', x0: m.x, y0: l.yaxis.range?l.yaxis.range[0]:0, x1: m.x, y1: m.y, line:{color:'red', dash:'dot', width:1}},
            {type: 'line', x0: l.xaxis.range?l.xaxis.range[0]:0, y0: m.y, x1: m.x, y1: m.y, line:{color:'red', dash:'dot', width:1}}
        ]);
        Plotly.relayout('plotDiv', {shapes: ns});

        const f = tabsData[activeTab].files.find(x => x.id === m.fileId);
        const tr = document.createElement('tr');
        if(f) tr.style.backgroundColor = hexToRgba(f.color, 0.2); 
        tr.innerHTML = `<td>${m.name}</td><td>${m.lineName}</td><td>${m.x.toFixed(2)}</td><td>${m.y.toFixed(2)}</td><td>${m.note}</td><td><button class="btn btn-xs btn-danger" onclick="removeMarker(${m.id})">Del</button></td>`;
        document.querySelector('#markerTable tbody').appendChild(tr);
    }

    window.removeMarker = (id) => { tabsData[activeTab].markers = tabsData[activeTab].markers.filter(m => m.id !== id); document.getElementById('plotBtn').click(); };
    window.clearMarkers = () => { tabsData[activeTab].markers = []; document.getElementById('plotBtn').click(); };

</script>

</body>
</html>
